<div class="row no-gutters">
  <div class="col left-panel pt-2">   
    <div class="groups">
      <div class="mb-2" *ngFor="let group of groups; let i = index">
        <div *ngIf="editGroupIndex === i; else groupDisplay">
          <form [formGroup]="editGroupForm">
            <div class="input-group input-group-sm input-group-sm-custom mb-2">
              <input
                id="edit-group-name"
                class="form-control form-control-sm"
                placeholder="Gruppenname"
                formControlName="groupName"
              />
              <button class="btn btn-outline-success" type="button" (click)="saveEditedGroup()">
                <i class="fa-regular fa-floppy-disk"></i>
              </button>
              <button class="btn btn-outline-danger" type="button" (click)="cancelEditGroup()">
                <i class="fa-solid fa-xmark"></i>
              </button> 
            </div>
            <div 
                class="invalid-feedback custom-invalid-feedback"
                *ngIf="editGroupForm.get('groupName')?.errors?.['required']"
            >
              Gruppenname ist erforderlich.
            </div>
          </form>
        </div>
        <ng-template #groupDisplay>
          <span class="group-name">
            <button class="btn-text-style" (click)="toggleGroupAttributes(i)">{{ group.name }} </button>
            <button class="btn-text-style green" (click)="editGroup(i)"><i class="fa-regular fa-pen-to-square"></i></button>
            <button class="btn-text-style red" (click)="removeGroup(i)">
              <i class="fa-regular fa-trash-can"></i>
            </button>
            <button class="btn-text-style blue" (click)="toggleGroupAttributes(i)">
              <i class="fa-solid" [ngClass]="group.hidden ? 'fa-eye-slash' : 'fa-eye'"></i>
            </button>
          </span>
        </ng-template>
        <div *ngIf="!group.hidden && group.form" [formGroup]="group.form">
          <div cdkDropList [id]="getGroupDropListId(i)" [cdkDropListData]="group.attributes"
               [cdkDropListConnectedTo]="connectedDropLists" 
               class="attr-group-list" (cdkDropListDropped)="drop($event, group)">
            <div class="attr-group-box" *ngFor="let attributeCtrl of getAttributeFormArray(group).controls; let j = index" [formGroup]="getFormGroupFromArray(getAttributeFormArray(group), j)" cdkDrag [cdkDragDisabled]="group.attributes[j].isFocused">
                <span class="attr-name col-3">{{ group.attributes[j].name }}</span>

                <span class="attr-value col-3">
                  <select *ngIf="group.attributes[j].input_type === 'Dropdown'" class="form-select form-select-sm" formControlName="value_varchar" (focus)="setFocus(group, j)" (blur)="removeFocus(group, j)">
                    <option *ngFor="let option of getDropdownOptions(group.attributes[j])" [value]="option.value">
                      {{ option.label }}
                    </option>
                  </select>
                  <input *ngIf="group.attributes[j].input_type === 'Dezimalzahlen'" type="text" class="form-control form-control-sm" formControlName="value_varchar" (focus)="setFocus(group, j)" (blur)="removeFocus(group, j)">
                  <input *ngIf="group.attributes[j].input_type === 'Ganzzahlen'" type="text" class="form-control form-control-sm" formControlName="value_varchar" (focus)="setFocus(group, j)" (blur)="removeFocus(group, j)">
                  <input *ngIf="group.attributes[j].input_type === 'Textfeld'" type="text" class="form-control form-control-sm" formControlName="value_varchar" (focus)="setFocus(group, j)" (blur)="removeFocus(group, j)">
                  <button *ngIf="group.attributes[j].input_type === 'Textbereich'" rows="5" class="form-control form-control-sm" (click)="openEditor(group, j)">Text bearbeiten</button>
                  <input *ngIf="group.attributes[j].input_type === 'Datumfeld'" type="date" class="form-control form-control-sm" formControlName="value_varchar" (focus)="setFocus(group, j)" (blur)="removeFocus(group, j)">
                  <input *ngIf="group.attributes[j].input_type === 'Link-Feld'" type="text" class="form-control form-control-sm" formControlName="value_varchar" (focus)="setFocus(group, j)" (blur)="removeFocus(group, j)">
                  <select *ngIf="group.attributes[j].input_type === 'Boolescher Wert'" class="form-select form-select-sm" formControlName="value_varchar" (focus)="setFocus(group, j)" (blur)="removeFocus(group, j)">
                    <option value="1">true</option>
                    <option value="0">false</option>
                  </select>
                  <input *ngIf="group.attributes[j].input_type === 'Dateifeld'" type="text" class="form-control form-control-sm" formControlName="value_varchar" (focus)="setFocus(group, j)" (blur)="removeFocus(group, j)">
                </span>
                <span class="attr-unit col">
                  {{ group.attributes[j].unit }}
                </span>

                <span *ngIf="group.attributes[j].is_frontend_visible" class="attr-frontend_visible green">
                  <i class="far fa-eye"></i>
                </span>
                <span *ngIf="!group.attributes[j].is_frontend_visible" class="attr-frontend_visible red">
                  <i class="fas fa-eye-slash"></i>
                </span>
                <button class="btn-text-style red" (click)="removeAttribute(group, group.attributes[j])">
                  <i class="fas fa-times"></i>
                </button>
              
              <div *ngIf="getFormGroupFromArray(getAttributeFormArray(group), j).get('value_text')?.value" [innerHTML]="getFormGroupFromArray(getAttributeFormArray(group), j).get('value_text')?.value"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <form [formGroup]="newGroupForm" *ngIf="addNewGroup">
      <div class="mb-3">
        <label class="form-label custom-label-sm" for="group-name">Gruppenname</label>
        <div class="input-group input-group-sm input-group-sm-custom">
          <input
            id="group-name"
            class="form-control form-control-sm"
            placeholder="Gruppenname"
            formControlName="groupName"
          />
          <button class="btn btn-outline-success" type="button" (click)="saveNewGroup()">
            <i class="fa-regular fa-floppy-disk"></i>
          </button>
          <button class="btn btn-outline-danger" type="button" (click)="cancelNewGroup()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div 
            class="invalid-feedback custom-invalid-feedback"
            *ngIf="editGroupForm.get('groupName')?.errors?.['required']"
        >
          Gruppenname ist erforderlich.
        </div>
      </div>
    </form>
    <button class="btn-text-style new-attribute-group" (click)="addNewGroupName()">
      <i class="fa-solid fa-circle-plus"></i> Neue Gruppe
    </button>
  </div>
  <div class="col-5 right-panel pt-2">
    <div cdkDropList [id]="tariffDropListId" [cdkDropListData]="tariffAttributes"
         [cdkDropListConnectedTo]="connectedDropLists" class="attr-group-list" 
         (cdkDropListDropped)="drop($event)" [cdkDropListEnterPredicate]="canDropToTariffList">
      <div class="attr-group-box" *ngFor="let attribute of tariffAttributes" cdkDrag [ngClass]="{'copied-attribute': attribute.isCopied}">
        <span class="attr-kennung col">{{attribute.code}}</span>
        <span class="attr-name col">{{attribute.name}}</span>
        <span *ngIf="attribute.is_frontend_visible" class="attr-frontend_visible green">
          <i class="far fa-eye"></i>
        </span>
        <span *ngIf="!attribute.is_frontend_visible" class="attr-frontend_visible red">
          <i class="fas fa-eye-slash"></i>
        </span>
      </div>
    </div>
  </div>
</div>